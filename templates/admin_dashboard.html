{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>üìù Recipe Management</h3>
    <div>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addRecipeModal">+ Add Recipe</button>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="card shadow-sm border-0">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Icon</th>
                        <th>Name</th>
                        <th>Time</th>
                        <th>Servings</th>
                        <th>Difficulty</th>
                        <th>Ingredients</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recipeTableBody">
                    {% for recipe in recipes %}
                    <tr data-index="{{ loop.index0 }}">
                        <td>{{ loop.index }}</td>
                        <td style="font-size: 24px;">{{ recipe.image }}</td>
                        <td>{{ recipe.name }}</td>
                        <td>{{ recipe.time }}</td>
                        <td>{{ recipe.servings }}</td>
                        <td>{{ recipe.difficulty }}</td>
                        <td><span class="badge bg-secondary">{{ recipe.ingredients|length }}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-btn" data-index="{{ loop.index0 }}" data-recipe='{{ recipe|tojson }}' title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                  <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                  <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                                </svg>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-index="{{ loop.index0 }}" data-name="{{ recipe.name }}" title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6Z"/>
                                  <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1ZM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118ZM2.5 3h11V2h-11v1Z"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Recipe Modal -->
<div class="modal fade" id="addRecipeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Recipe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRecipeForm">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Recipe Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Icon Emoji</label>
                            <input type="text" class="form-control" name="image" placeholder="üç≤" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Time</label>
                            <input type="text" class="form-control" name="time" placeholder="30 min" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Servings</label>
                            <input type="text" class="form-control" name="servings" placeholder="4" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Difficulty</label>
                            <select class="form-select" name="difficulty" required>
                                <option value="Easy">Easy</option>
                                <option value="Medium">Medium</option>
                                <option value="Hard">Hard</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Ingredients (one per line)</label>
                            <textarea class="form-control" name="ingredients" rows="4" placeholder="tomato&#10;onion&#10;garlic" required></textarea>
                            <small class="text-muted">Enter each ingredient on a new line</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Instructions</label>
                            <textarea class="form-control" name="instructions" rows="3" required></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveRecipeBtn">Save Recipe</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Recipe Modal -->
<div class="modal fade" id="editRecipeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Recipe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editRecipeForm">
                    <input type="hidden" name="index" id="editIndex">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Recipe Name</label>
                            <input type="text" class="form-control" name="name" id="editName" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Icon Emoji</label>
                            <input type="text" class="form-control" name="image" id="editImage" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Time</label>
                            <input type="text" class="form-control" name="time" id="editTime" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Servings</label>
                            <input type="text" class="form-control" name="servings" id="editServings" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Difficulty</label>
                            <select class="form-select" name="difficulty" id="editDifficulty" required>
                                <option value="Easy">Easy</option>
                                <option value="Medium">Medium</option>
                                <option value="Hard">Hard</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Ingredients (one per line)</label>
                            <textarea class="form-control" name="ingredients" id="editIngredients" rows="4" required></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Instructions</label>
                            <textarea class="form-control" name="instructions" id="editInstructions" rows="3" required></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateRecipeBtn">Update Recipe</button>
            </div>
        </div>
    </div>
</div>

<script>
// Add Recipe
document.getElementById('saveRecipeBtn').addEventListener('click', async () => {
    const form = document.getElementById('addRecipeForm');
    const formData = new FormData(form);
    const data = {
        name: formData.get('name'),
        image: formData.get('image'),
        time: formData.get('time'),
        servings: formData.get('servings'),
        difficulty: formData.get('difficulty'),
        ingredients: formData.get('ingredients').split('\n').map(i => i.trim()).filter(i => i),
        instructions: formData.get('instructions')
    };
    
    try {
        const res = await fetch('/admin/recipe/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (err) {
        alert('Failed to add recipe: ' + err.message);
    }
});

// Edit Recipe
document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const index = btn.dataset.index;
        const recipe = JSON.parse(btn.dataset.recipe);
        
        document.getElementById('editIndex').value = index;
        document.getElementById('editName').value = recipe.name;
        document.getElementById('editImage').value = recipe.image;
        document.getElementById('editTime').value = recipe.time;
        document.getElementById('editServings').value = recipe.servings;
        document.getElementById('editDifficulty').value = recipe.difficulty;
        document.getElementById('editIngredients').value = recipe.ingredients.join('\n');
        document.getElementById('editInstructions').value = recipe.instructions;
        
        new bootstrap.Modal(document.getElementById('editRecipeModal')).show();
    });
});

document.getElementById('updateRecipeBtn').addEventListener('click', async () => {
    const form = document.getElementById('editRecipeForm');
    const formData = new FormData(form);
    const index = formData.get('index');
    const data = {
        name: formData.get('name'),
        image: formData.get('image'),
        time: formData.get('time'),
        servings: formData.get('servings'),
        difficulty: formData.get('difficulty'),
        ingredients: formData.get('ingredients').split('\n').map(i => i.trim()).filter(i => i),
        instructions: formData.get('instructions')
    };
    
    try {
        const res = await fetch(`/admin/recipe/edit/${index}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (err) {
        alert('Failed to update recipe: ' + err.message);
    }
});

// Delete Recipe
document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
        const index = btn.dataset.index;
        const name = btn.dataset.name;
        
        if (!confirm(`Are you sure you want to delete "${name}"?`)) return;
        
        try {
            const res = await fetch(`/admin/recipe/delete/${index}`, { method: 'DELETE' });
            const result = await res.json();
            if (result.success) {
                location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        } catch (err) {
            alert('Failed to delete recipe: ' + err.message);
        }
    });
});
</script>
{% endblock %}
