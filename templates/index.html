{% extends 'base.html' %}
{% block head %}{% endblock %}
{% block content %}
<div id="offlineBanner" class="alert alert-warning d-none mb-4" role="alert">
  <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
    <div class="d-flex align-items-center">
      <span class="me-2" style="font-size: 1.5rem;">üì°</span>
      <div>
        <strong>Offline Mode</strong> - You can browse recipes, but camera and upload features are disabled. Connect to the internet to detect ingredients.
      </div>
    </div>
    <button id="offlineBrowseBtn" class="btn btn-warning flex-shrink-0">
      <span class="me-1">üìö</span> Browse All Recipes
    </button>
  </div>
</div>
<div class="row g-4">
    <div class="col-lg-5">
        <section class="card shadow-sm border-0">
            <div class="card-body">
                <h5 class="card-title mb-3">Capture or Upload</h5>
                <p class="text-muted small mb-3">Use your camera or upload a photo of ingredients. We'll detect and suggest recipes.</p>

                <div id="cameraContainer" class="mb-3 d-none">
                    <video id="videoElement" autoplay playsinline class="w-100 rounded-3 bg-dark ratio ratio-4x3"></video>
                </div>
                <div id="previewContainer" class="mb-3 d-none">
                    <div class="position-relative">
                        <img id="preview" class="img-fluid rounded-3 shadow-sm" alt="Preview" />
                        <button id="clearPreviewBtn" class="btn btn-sm btn-danger position-absolute" style="top: 10px; right: 10px; z-index: 10;" title="Clear image">
                            <span aria-hidden="true">√ó</span>
                        </button>
                    </div>
                </div>

                <div class="d-flex flex-wrap gap-2">
                    <button id="startCameraBtn" class="btn btn-success">
                        <span class="me-1">üì∑</span> Start Camera
                    </button>
                    <button id="captureBtn" class="btn btn-primary d-none">
                        <span class="me-1">üì∏</span> Capture Photo
                    </button>
                    <button id="stopCameraBtn" class="btn btn-outline-secondary d-none">Stop Camera</button>
                    <label for="imageUpload" class="btn btn-info text-white mb-0">üìÅ Upload Image</label>
                    <input type="file" id="imageUpload" class="d-none" accept="image/*">
                </div>

                <div id="dropZone" class="drop-zone mt-3 d-none d-md-block">
                    <div class="dz-instructions">or drag &amp; drop an image here</div>
                </div>

                <div id="loadingIndicator" class="text-center my-4 d-none">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Analyzing image with Roboflow‚Ä¶</p>
                </div>

                <div id="detectionInfo" class="alert alert-primary d-none" role="alert">
                    <div class="d-flex align-items-center mb-2">
                        <strong class="me-2">Detections</strong>
                        <span class="badge bg-light text-dark">confidence %</span>
                    </div>
                    <div id="rawDetections"></div>
                </div>
            </div>
        </section>
    </div>

    <div class="col-lg-7">
        <section id="ingredientsCard" class="card border-0 shadow-sm mb-4 d-none">
            <div class="card-body">
                <h5 class="card-title mb-3">Detected Ingredients</h5>
                <div id="ingredientList" class="mt-2"></div>
            </div>
        </section>

        <section id="basketCard" class="card border-0 shadow-sm mb-4 d-none">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h5 class="card-title mb-0">Your Ingredients</h5>
                    <div class="d-flex gap-2">
                        <button id="clearBasketBtn" class="btn btn-sm btn-outline-secondary">Clear</button>
                    </div>
                </div>
                <div id="basketList"></div>
                <div class="small text-muted mt-2">Detected ingredients are automatically added. Capture or upload another image to add more.</div>
            </div>
        </section>

        <section id="recipesCard" class="card border-0 shadow-sm d-none">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <h5 id="recipes" class="card-title mb-0">Recommendations</h5>
                    <div class="d-flex align-items-center gap-2">
                        <button id="closeRecipesBtn" class="btn btn-sm btn-outline-secondary d-none" title="Back" style="min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;">
                            √ó
                        </button>
                        <span class="text-muted small">Sorted by highest match</span>
                    </div>
                </div>
                <div id="recipesEmpty" class="text-center text-muted py-4 d-none">
                    <div class="mb-2" style="font-size:32px">üßë‚Äçüç≥</div>
                    <div>No recipes match yet.</div>
                    <div class="small">Try adding more ingredients for better matches.</div>
                </div>
                <div class="row mt-3" id="recipeContainer"></div>
                <div id="recipePagination" class="d-flex justify-content-between align-items-center mt-3 d-none">
                    <button id="prevPageBtn" class="btn btn-outline-secondary btn-sm" disabled>‚Üê Previous</button>
                    <span id="pageInfo" class="text-muted small">Page 1</span>
                    <button id="nextPageBtn" class="btn btn-outline-secondary btn-sm">Next ‚Üí</button>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Recipe Detail Modal -->
<div class="modal fade" id="recipeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recipeModalLabel">Recipe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div id="modalEmoji" style="font-size:48px"></div>
                    <div>
                        <div class="fw-semibold" id="modalMeta"></div>
                        <div class="badge bg-success" id="modalMatch"></div>
                    </div>
                </div>
                
                <div class="row g-3" id="modalIngredients">
                    <!-- Ingredient sections will be dynamically populated -->
                </div>
                <hr/>
                <h6>Instructions</h6>
                <p id="modalInstructions" class="mb-0"></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Embed recipes data for offline access
  window.OFFLINE_RECIPES = {{ recipes_json|safe }};
</script>
{% endblock %}
